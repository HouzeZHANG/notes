# 汇编语言-王爽
# Content
- [汇编语言-王爽](#汇编语言-王爽)
- [Content](#content)
- [第四章 第一个程序](#第四章-第一个程序)
  - [4.1 一个源程序从写出到执行的过程](#41-一个源程序从写出到执行的过程)
  - [4.2 源程序](#42-源程序)
  - [4.3 编辑源程序](#43-编辑源程序)
  - [4.4 编译源文件](#44-编译源文件)
  - [4.5 连接](#45-连接)
  - [4.9 程序执行过程的跟踪](#49-程序执行过程的跟踪)

# 第四章 第一个程序

## 4.1 一个源程序从写出到执行的过程

1. 编辑源程序文件
2. 调用汇编编译器生成目标文件
3. 连接目标文件生成可执行程序

可**执行文件**包括两部分内容（**程序和数据+相关的描述信息**）

在程序运行的初始阶段，操作系统会根据相关的描述信息，来初始化内存和寄存器，将CSIP指向第一条要执行的指令

## 4.2 源程序

源程序包含两种指令——**汇编指令+伪指令**

汇编指令有对应的机器代码，而伪指令是给编译器阅读的，用来协助编译器编译

```x86asm
assume cs:codesg

//伪指令
codesg segment

    mov ax,0123H
    mov bx,0456H
    add ax,bx
    add ax,ax

    mov ax,4c00H
    int 21H

//伪指令
codesg ends

end
```

1. `segment-ends`段开始与段结束，一个源程序中所有的被计算机所处理的信息都将被划分到不同的段中
2. `end`汇编程序结束标志
3. `assume`假设某个段寄存器和segment相关联
4. `codesg`这个标号最终会转化为一个**段地址**

事实上在debug中我们一样可以编程，但是如果要组织一个比较大的程序的时候，就需要使用**结构化的程序**

***程序返回***：正在运行的P1程序将P2从可执行文件中加载到内存，随后将CPU的控制权交给P2，P2开始运行之后，P1暂停运行。当P2运行完毕之后，将CPU的控制权**交还给**P1

所以有必要在程序的末尾添加返回的指令，用以下代码实现：
```x86asm
mov ax,4c00H
int 21H
```
如果不添加以上代码，程序不存在**语法错误**，但存在**逻辑错误**

## 4.3 编辑源程序

`edit`

## 4.4 编译源文件

使用`masm`将`.asm`编译成`.obj`

## 4.5 连接

用`link.exe`将`1.obj`连接成`1.exe`

连接的作用：
1. 当源程序很大的时候，将其分散为多个源文件来编译
2. 程序调用了库文件的程序，连接环节将目标文件和库文件的程序相连
3. 目标文件中的某些内容还不能直接用来生成可执行文件，就算只有一个目标文件，也必须使用`link`

**dos的shell叫command**，command负责设置CS:IP

## 4.9 程序执行过程的跟踪

`debug.exe`将程序载入内存，但并不放弃对CPU的控制

DOS系统中`.exe`文件的加载过程：
![](https://img-blog.csdnimg.cn/20200727160624300.png)

1. 程序所在的内存段地址存放在`DS`寄存器中
2. `DS`段前256字节存放用于和程序通信的PSP，随后是程序主体`SA+10H:0`
3. 记得使用p指令来执行`int 21`